<link rel="import" href="optinomic-title/optinomic-title.html">
<link rel="import" href="optinomic-elements-helpers/optinomic-app-info.html">
<link rel="import" href="optinomic-elements-helpers/optinomic-indication.html">
<link rel="import" href="iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="iron-collapse/iron-collapse.html">
<link rel="import" href="vaadin-grid/vaadin-grid.html">
<link rel="import" href="vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="vaadin-grid/vaadin-grid-column-group.html">
<dom-module id="element-export">
    <template>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .full_grid {
            height: 100%;
            border-left-style: none;
            border-right-style: none;
            border-bottom-style: none;
        }

        .chart {
            border-top-style: solid;
            border-top-color: #F5F5F5;
            border-top-width: 1px;
            border-bottom-style: solid;
            border-bottom-color: #F5F5F5;
            border-bottom-width: 1px;
            margin-top: 24px;
            margin-bottom: 12px;
        }
        </style>
        <div id="element">
            <div id="title" class="layout horizontal flex">
                <div class="flex">
                    <optinomic-title small h1="[[fileDefinitions.options.name]]" h3="[[fileDefinitions.options.paitent_app_id]]:[[fileDefinitions.options.calculation_id]] ([[_sr.survey_responses.length]])"></optinomic-title>
                </div>
                <template is="dom-if" if="[[_d.init_done]]" restamp="true">
                    <div class="horizontal">
                        <div>
                            <paper-icon-button class="grey" on-tap="__onDownloadDebug" icon="bug-report"></paper-icon-button>
                            <a href="#" id="fileLinkDebug" hidden download$="[[fileDefinitions.options.name]].json"></a>
                        </div>
                        <div>
                            <paper-button class="grey" on-tap="__onDownload">Speichern</paper-button>
                            <a href="#" id="fileLink" hidden download$="[[fileDefinitions.options.name]].csv"></a>
                        </div>
                    </div>
                </template>
                <template is="dom-if" if="[[!_d.init_done]]" restamp="true">
                    <optinomic-indication sign=":" title="Daten bereitstellen..." color="#3F51B5"></optinomic-indication>
                </template>
            </div>
        </div>
    </template>
    <script>
    Polymer({
        is: 'element-export',

        behaviors: [ReduxBehavior, AsyncActionsBehavior, optinomicExportToolbox],

        properties: {
            fileDefinitions: {
                type: Object,
                observer: '_loadData'
            },
            _d: {
                type: Object
            },
            _sr: {
                type: Object,
                statePath: function(state) {
                    return_obj = null;
                    if ((state._app_userapp_calculations !== null) && (state._app_userapp_calculations !== undefined)) {
                        if ((this.fileDefinitions !== null) && (this.fileDefinitions !== undefined)) {

                            var home_str = this.fileDefinitions.options.app_id.split('.').join("_");
                            var path = home_str + "___" + this.fileDefinitions.options.calculation_id;
                            if ((state._app_userapp_calculations[path] !== null) && (state._app_userapp_calculations[path] !== undefined)) {

                                return state._app_userapp_calculations[path].data;

                            };
                        };
                    };
                    return return_obj;
                },
                observer: '_sr_ready'
            }
        },


        // -----------------------------
        // User-Click Functions
        // -----------------------------

        __onDownload(e) {
            e.preventDefault();

            // File Content
            var content = this._csv_file;

            var jsonLink = this.$$('#fileLink');
            const link = this._createFile(content);

            // console.log('File Content', content, jsonLink);

            jsonLink.href = link;
            jsonLink.click();
        },

        __onDownloadDebug(e) {
            e.preventDefault();

            // File Content
            var content = JSON.stringify(this._sr, null, 2);

            var jsonLink = this.$$('#fileLinkDebug');
            const link = this._createFile(content);

            // console.log('File Content', content, jsonLink);

            jsonLink.href = link;
            jsonLink.click();
        },

        // --------------------------------
        // Helpers
        // --------------------------------
        _createFile(text) {
            const textBlob = new Blob([text], { type: 'text/plain' });
            return window.URL.createObjectURL(textBlob);
        },


        // -----------------------------
        // Functions
        // -----------------------------

        _init: function() {

            var d = {};

            d.fileDefinitions = this.fileDefinitions;

            include(definitions/_default_bottom_fields.js)

            this._createCSVFile(d.fileDefinitions);

            // Set & Log
            d.init_done = true;
            this.set('_d', d);
            this._d = d;
            console.log('(INIT) ' + d.fileDefinitions.options.name, d);
        },


        _dataDive: function(source, field) {

            var path_array = field.path.split(".");

            var value = Object.assign({}, source);
            if ((value !== null) && (value !== undefined)) {
                path_array.forEach(function(path, pathID) {
                    try {
                        value = value[path];
                    } catch (err) {
                        value = "";
                    };

                });
            };

            if ((value === undefined) || (value === null)) {
                value = "";
            };

            // console.log('(_dataDive) ', value, source, path_array);

            return value;
        },


        _createCSVFile: function(def) {

            this.debounce('_createCSVFile', function() {
                // console.log('_createCSVFile', this._sr);

                if ((this._sr !== undefined) && (this._sr !== null)) {
                    if (this._sr.survey_responses.length > 0) {

                        // We have data -> Proceed.
                        var _sr = this.get('_sr');

                        if ("survey_responses" in _sr) {
                            var survey_responses = this._sr.survey_responses;

                            // console.log('-> survey_responses', survey_responses);

                            var f = "";
                            var header_str = "";
                            var header_written = false;
                            var rows_str = "";
                            var delimitter = def.options.delimitter;
                            var newline = "\n";

                            survey_responses.forEach(function(sr, srID) {

                                var fields = def.fields;

                                if ((fields !== null) && (fields !== undefined)) {
                                    fields.forEach(function(field, fieldID) {

                                        // Header
                                        if ((header_written === false) && (sr.all_found)) {
                                            header_str = header_str + field.name;

                                            if (fieldID === fields.length - 1) {
                                                // Last
                                                header_str = header_str + newline;
                                            } else {
                                                // Not last
                                                header_str = header_str + delimitter;
                                            };
                                        };

                                        // Rows
                                        rows_str = rows_str + this._dataDive(sr, field);
                                        if (fieldID === fields.length - 1) {
                                            // Last
                                            if (srID !== survey_responses.length - 1) {
                                                // Not File-End
                                                rows_str = rows_str + newline;
                                            };
                                        } else {
                                            // Not last
                                            rows_str = rows_str + delimitter;
                                        };

                                    }.bind(this));

                                    if (header_str !== "") {
                                        header_written = true;
                                    };

                                };
                            }.bind(this));

                            var file = header_str + rows_str;
                            // console.log('-> file', file);

                            this.set('_csv_file', file);

                        };
                    };
                };
            }, 250);
        },


        // -----------------------------
        // Observer
        // -----------------------------

        _loadData: function() {
            this.debounce('_loadData', function() {
                if ((this.fileDefinitions !== null) && (this.fileDefinitions !== undefined)) {
                    Polymer.RenderStatus.afterNextRender(this, function() {

                        this.dispatch('actionGetUserAppCalculation', this.fileDefinitions.options.app_id, this.fileDefinitions.options.calculation_id);

                    });
                };

            }, 250);
        },

        _sr_ready: function() {
            this.debounce('_sr_ready', function() {
                if ((this._sr !== null) && (this._sr !== undefined)) {
                    var fileDefinitions = this.get('fileDefinitions');
                    if ((fileDefinitions !== null) && (fileDefinitions !== undefined)) {
                        Polymer.RenderStatus.afterNextRender(this, function() {
                            this._init();
                        });
                    };
                };

            }, 250);
        },

        // -----------------------------
        // Lifecycle
        // -----------------------------

        ready: function() {

            var d = {};
            d.init_done = false;
            this.set('_d', d);

        }
    });
    </script>
</dom-module>