<head>
    <link rel="import" href="iron-icons/iron-icons.html">
    <link rel="import" href="paper-icon-button/paper-icon-button.html">
    <link rel="import" href="paper-button/paper-button.html">
</head>
<dom-module id="optinomic-app">
    <template>
        <style include="shared-styles">
        :host {
            display: block;
            padding: 10px;
        }
        </style>
        <div class="">
            <h1>[[params.appName]]</h1>
            <p>[[params.appName]]</p>
            <div class="circle">[[params.patientID]]</div>
        </div>
        <div id="container">
            <paper-button on-tap="callAPI" class="pink">link</paper-button>
            <paper-button on-tap="callAPI" raised class="indigo">raised</paper-button>
            <paper-button on-tap="callAPI" toggles raised class="green">toggles</paper-button>
            <paper-button on-tap="callAPI" disabled class="disabled">disabled</paper-button>
        </div>
        <div id="container">
            <paper-icon-button on-tap="callAPI" icon="favorite"></paper-icon-button>
            <paper-icon-button on-tap="callAPI" icon="menu" class="indigo"></paper-icon-button>
            <paper-icon-button on-tap="callAPI" icon="star"></paper-icon-button>
        </div>
        <div>
            <template is="dom-if" if="[[loading]]">
                <p>Loading...</p>
            </template>
            <template is="dom-if" if="[[username]]">
                <p>Welcome [[username]]!</p>
            </template>
        </div>
    </template>
    <script>
    // ---------------------------------
    // REDUX - STORE
    // ---------------------------------

    const initialState = {
        username: null,
        loading: false
    };

    const reducer = (state, action) => {
        if (!state) return initialState;
        switch (action.type) {
            case 'SIGN_UP_STARTED':
                return Object.assign({}, state, {
                    loading: true
                });

            case 'SIGN_UP_COMPLETE':
                return Object.assign({}, state, {
                    loading: false,
                    username: action.username
                });
        }
    }
    const store = Redux.createStore(
        reducer,
        Redux.applyMiddleware(ReduxThunk.default)
    );
    const ReduxBehavior = PolymerRedux(store);
    const AsyncActionsBehavior = {
        actions: {
            signUpWithTimeout: function(username) {
                return function(dispatch) {
                    dispatch({
                        type: 'SIGN_UP_STARTED'
                    });
                    // Do async task
                    setTimeout(function() {
                        dispatch({
                            type: 'SIGN_UP_COMPLETE',
                            username: username
                        });
                    }, 3000);
                }
            }
        }
    };


    // ---------------------------------
    // POLYMER
    // ---------------------------------

    Polymer({
        is: 'optinomic-app',
        ready: function() {
            console.log(this.localName + '#' + this.id + ' has local DOM initialized');
            this.params = {
                "userID": helpers.getUserID(),
                "patientID": helpers.getPatientID(),
                "stayID": helpers.getStayID(),
                "token": helpers.getToken(),
                "appName": helpers.getAppName(),
                "appID": helpers.getAppID(),
                "apiURL": helpers.getApiURL(),
            };
        },
        callAPI: function() {
            console.log('HELLO: callAPI!');
            helpers.callAPI('GET', '/clinic', {}, {}, function(req) {
                if (req.status == 200) {
                    var response = JSON.parse(req.response);
                    console.log('The response is ', response);
                } else {
                    console.err('Error: Failed with status code', req.status);
                }
            });
        },
        behaviors: [ReduxBehavior, AsyncActionsBehavior],
        signUp: function() {
            const username = helpers.getAppName();
            this.dispatch('signUpWithTimeout', username);
        },
        properties: {
            loading: {
                type: Boolean,
                statePath: 'loading'
            },
            username: {
                type: String,
                statePath: 'username'
            }
        }
    });
    </script>
</dom-module>
