<link rel="import" href="polymer/polymer-element.html">
<link rel="import" href="paper-button/paper-button.html">
<link rel="import" href="paper-spinner/paper-spinner.html">
<link rel="import" href="iron-collapse/iron-collapse.html">
<link rel="import" href="optinomic-elements/optinomic-clipboard/optinomic-clipboard.html">

<dom-module id="element-export">
  <template>
    <style include="optinomic-styles">
      :host {
        display: block;
      }

      .container {
        border-top: 1px solid #E0E0E0;
      }

    </style>

    <div class="container">
      <div class="horizontal">
        <div style="width:48px;text-align:center">
          <template is="dom-if" if="[[_loading]]" restamp="true">
            <paper-spinner active></paper-spinner>
          </template>
          <template is="dom-if" if="[[!_loading]]" restamp="true">
            <template is="dom-if" if="[[_data_ready]]" restamp="true">
              <paper-icon-button icon="file-download" on-click="_getInputData" class="grey"></paper-icon-button>
            </template>
          </template>
        </div>

        <div class="flex" style="padding-top:10px;">
          <h4 style="margin:0;color:#3F51B5">[[definition.options.name]]</h4>
          <p class="caption" style="margin-top:-6px;">[[definition.options.userapp_id]] | [[definition.options.userapp_calculation_id]]</p>
        </div>

        <div style="width:128px;">
          <template is="dom-if" if="[[_data_ready]]" restamp="true">
            <paper-button class="indigo" on-click="_loadData">CSV</paper-button>
            <paper-icon-button icon="more-vert" on-click="_showMore" class="grey"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[!_data_ready]]" restamp="true">
            <paper-button class="grey" on-click="_loadData">Anfordern</paper-button>
          </template>
        </div>

      </div>
      <iron-collapse id="collapse">
        <div class="horizontal">
          <div style="width:48px;text-align:center">&nbsp;</div>

          <div class="flex" style="margin-top:24px;margin-bottom:24px;">
            <div class="horizontal">

              Definition
              <optinomic-clipboard text="[[definition]]"></optinomic-clipboard>

            </div>

          </div>

        </div>
      </iron-collapse>
    </div>

  </template>

  <script>

    class elementExport extends Polymer.mixinBehaviors([opappBehavior], ReduxBehavior(Polymer.Element)) {

      static get is() {
        return 'element-export';
      }

      static get actions() {
        return AsyncActionsBehavior.actions;
      }

      // Properties
      static get properties() {
        return {

          definition: {
            type: Object
          },

          autorequest: {
            type: Boolean,
            value: false,
            observer: 'autorequestChanged'
          },

          _sr: {
            type: Object,
            statePath: function (state) {
              var return_obj = null;
              if ((state._app_userapp_calculations !== null) && (state._app_userapp_calculations !== undefined)) {
                if ((this.definition !== null) && (this.definition !== undefined)) {

                  var home_str = this.definition.options.userapp_id.split('.').join("_");
                  var path = home_str + "___" + this.definition.options.userapp_calculation_id;
                  if ((state._app_userapp_calculations[path] !== null) && (state._app_userapp_calculations[path] !== undefined)) {

                    return_obj = state._app_userapp_calculations[path].data;

                  };
                };
              };
              return return_obj;
            },
            observer: '_sr_ready'
          }

        };
      }

      // --------------- Functions ---------------

      _getState() {
        console.warn(store.getState());
      }

      _getInputData() {
        console.warn(this._sr);
      }

      _showMore() {
        this.$.collapse.toggle();
      }

      _loadData() {
        this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(250), () => {
          if ((this.definition !== null) && (this.definition !== undefined)) {
            Polymer.RenderStatus.afterNextRender(this, function () {

              this.set('_loading', true);
              console.log('_loadData', this.definition, this.autorequest);
              this.dispatch('actionGetUserAppCalculation', this.definition.options.userapp_id, this.definition.options.userapp_calculation_id);

            });
          };

        });
      }

      // --------------- Observers ---------------

      _sr_ready() {
        this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(250), () => {

          if ((this._sr !== undefined) && (this._sr !== null)) {
            this._getState();
            this.set('_loading', false);
            this.set('_data_ready', true);
            this.set('_sr_string', JSON.stringify(this._sr));
          };

        });
      }

      autorequestChanged() {
        this._debouncer = Polymer.Debouncer.debounce(this._debouncer, Polymer.Async.timeOut.after(250), () => {

          if ((this.autorequest) && ((this._data_ready === false))) {
            this._loadData();
          };

        });
      }

      // --------------- Lifecycle ---------------

      _init() {
        this.set('_data_ready', false);
        console.warn('_init :: Export-Toolbox', this.definition);
      }

      ready() {
        super.ready();
        this._init();
      }
    }

    window.customElements.define(elementExport.is, elementExport);
  </script>
</dom-module>
