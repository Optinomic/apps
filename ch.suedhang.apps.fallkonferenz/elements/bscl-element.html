<link rel="import" href="optinomic-title/optinomic-title.html">
<link rel="import" href="optinomic-chart-profile/optinomic-chart-profile.html">
<link rel="import" href="optinomic-pdf-chart-profile/optinomic-pdf-chart-profile.html">
<link rel="import" href="optinomic-pdfmake/optinomic-pdfmake.html">
<link rel="import" href="iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="iron-collapse/iron-collapse.html">
<link rel="import" href="vaadin-grid/vaadin-grid.html">
<link rel="import" href="vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="vaadin-grid/vaadin-grid-column-group.html">
<dom-module id="bscl-element">
    <template>
        <style include="shared-styles">
         :host {
            display: block;
        }

        .full_grid {
            height: 100%;
            border-left-style: none;
            border-right-style: none;
            border-bottom-style: none;
        }

        .readme_container {
            background-color: #FAFAFA;
            border-style: solid;
            border-color: #EEEEEE;
            border-width: 1px;
            border-radius: 3px;
            padding: 24px;
        }
        </style>
        <template is="dom-if" if="[[_d.init_done]]" restamp="true">
            <div class="grid-border-top">
                <div class="layout horizontal flex">
                    <div class="flex">
                        <optinomic-title small h1="[[_d.title]]" h2="[[_d.subtitle]]" h3="[[_d.name]]"></optinomic-title>
                    </div>
                    <div>
                        <template is="dom-if" if="[[_current_app.found]]">
                            <div hidden$="[[_show_help]]">
                                <paper-icon-button class="grey" on-tap="__toggleHelp" icon="help-outline"></paper-icon-button>
                            </div>
                            <div hidden$="[[!_show_help]]">
                                <paper-icon-button class="grey" on-tap="__toggleHelp" icon="close"></paper-icon-button>
                            </div>
                        </template>
                    </div>
                    <div>
                        <template is="dom-if" if="[[_pdf_ready]]">
                            <paper-icon-button class="grey" on-tap="__toggle_print" icon="print"></paper-icon-button>
                        </template>
                    </div>
                </div>
                <template is="dom-if" if="[[_current_app.found]]">
                    <p>[[_current_app.app.description]]</p>
                    <iron-collapse id="collapse_help">
                        <div hidden$="[[!_show_help]]">
                            <div class="readme_container">
                                <h4 style="margin-top:24px;color:#212121">HILFE (Readme)</h4>
                                <div id="readme"></div>
                            </div>
                        </div>
                    </iron-collapse>
                </template>
                <template is="dom-if" if="[[!_sr.have_data]]">
                    <h3>Keine BSCL-Daten vorhanden.</h3>
                </template>
                <template is="dom-if" if="[[_sr.have_data]]">
                    <template is="dom-if" if="[[_d.bscl_clinic_sample_dive.defined]]" restamp="true">
                        <div id="pdf">
                            <iron-collapse id="collapse_print" horizontal>
                                <optinomic-pdfmake header-left="[[_patient.extras.full_name]]" header-right="[[_clinic.clinic_name]]" document-title="[[_d.name]]" content="[[_pdf_content]]" loading-string="[[_d.loading_string]]"></optinomic-pdfmake>
                            </iron-collapse>
                            <optinomic-pdf-chart-profile language="de" options="[[_d.bscl.options_pdf]]" scales="[[_d.bscl.scales]]" ranges="[[_d.bscl.ranges]]" scores="[[_sr]]" clinic_samples="[[_d.clinic_samples]]" clinic_sample_dive="[[_d.bscl_clinic_sample_dive.array]]" pdf-content="{{_pdf_chart}}"></optinomic-pdf-chart-profile>
                        </div>
                        <div id="content">
                            <optinomic-chart-profile language="de" options="[[_d.bscl.options]]" scales="[[_d.bscl.scales]]" ranges="[[_d.bscl.ranges]]" scores="[[_sr]]" clinic_samples="[[_d.clinic_samples]]" clinic_sample_dive="[[_d.bscl_clinic_sample_dive.array]]"></optinomic-chart-profile>
                            <template is="dom-if" if="[[_d.bscl_zusatzitems.defined]]" restamp="true">
                                <h3>Zusatzangaben</h3>
                                <vaadin-grid class="full_grid" aria-label="Zusatzangaben" items="[[_d.bscl_zusatzitems.array]]" column-reordering-allowed="true">
                                    <vaadin-grid-column-group>
                                        <template class="header"><span class="body-1" stlye="color:#212121;font-weight:400;">Messung</span></template>
                                        <vaadin-grid-column width="100px" flex-grow="0">
                                            <template class="header">
                                                <vaadin-grid-sorter path="mz_date">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Datum</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1" style="text-align: right">[[item.mz_datum]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column width="180px" flex-grow="0">
                                            <template class="header">
                                                <vaadin-grid-sorter path="mz_id">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Zeitpunkt</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1">[[item.mz_typ]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid-column-group>
                                    <vaadin-grid-column-group>
                                        <template class="header"><span class="body-1" stlye="color:#212121;font-weight:400;">Zusatzangaben</span></template>
                                        <vaadin-grid-column>
                                            <template class="header">
                                                <vaadin-grid-sorter path="0__field">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Schlechter Appetit</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1">[[item.0__result]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column>
                                            <template class="header">
                                                <vaadin-grid-sorter path="1__field">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Einschlafschwierigkeiten</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1">[[item.1__result]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column>
                                            <template class="header">
                                                <vaadin-grid-sorter path="2__field">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Suizidalität: Gedanken an den Tod und ans Sterben</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1">[[item.2__result]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                        <vaadin-grid-column>
                                            <template class="header">
                                                <vaadin-grid-sorter path="3__field">
                                                    <span class="body-1" stlye="color:#424242;font-weight:400;">Schuldgefühle</span>
                                                </vaadin-grid-sorter>
                                            </template>
                                            <template>
                                                <span draggable="true" class="body-1">[[item.3__result]]</span>
                                            </template>
                                        </vaadin-grid-column>
                                    </vaadin-grid-column-group>
                                </vaadin-grid>
                            </template>
                        </div>
                    </template>
                    <template is="dom-if" if="[[!_d.bscl_clinic_sample_dive.defined]]">
                        <p style="color:#3F51B5">Erstelle Klinikstichprobe aus letzter Messung...</p>
                    </template>
                </template>
            </div>
        </template>
        <template is="dom-if" if="[[!_d.init_done]]">
            <p style="color:#3F51B5">Initialisiere...</p>
        </template>
    </template>
    <script>
    Polymer({
        is: 'bscl-element',

        behaviors: [ReduxBehavior, AsyncActionsBehavior],

        properties: {
            appId: {
                type: String,
                value: null,
                observer: '_loadData'
            },
            _patient: {
                type: Object,
                statePath: function(state) {
                    if ((state.patient.data !== null) && (state.patient.data !== undefined)) {
                        return state.patient.data;
                    } else {
                        return null
                    };
                }
            },
            _clinic: {
                type: Object,
                statePath: function(state) {
                    if ((state.clinic.data !== null) && (state.clinic.data !== undefined)) {
                        return state.clinic.data;
                    } else {
                        return null
                    };
                }
            },
            _current_app: {
                type: Object,
                statePath: function(state) {
                    var return_obj = {
                        "found": false,
                        "app": {}
                    };
                    if ((this.appId !== null) && (this.appId !== undefined)) {
                        if ((state.apps.all.patient_modules !== null) && (state.apps.all.patient_modules !== undefined)) {
                            var appId = this.appId;
                            state.apps.all.patient_modules.forEach(function(pm, appID) {
                                if (pm.identifier === appId) {
                                    return_obj = return_obj = {
                                        "found": true,
                                        "app": pm
                                    };
                                };
                            });
                        };
                    };
                    return return_obj;
                }
            },
            _sr: {
                type: Object,
                statePath: function(state) {
                    if ((this.appId !== null) && (this.appId !== undefined)) {
                        if (this.appId in state.survey_responses.data) {
                            // console.log('(bscl-element) _sr:', state.survey_responses.data[this.appId]);
                            return state.survey_responses.data[this.appId]
                        } else {
                            return null
                        };
                    } else {
                        return null
                    };
                },
                observer: '_srChanged'
            },
            _pdf_chart: {
                type: Object,
                value: null,
                observer: '_buildPDF'
            },
        },


        // -----------------------------
        // User-Click Functions
        // -----------------------------

        __toggle_print: function() {
            var print_button = this.$$('#collapse_print');
            print_button.toggle();
        },

        __toggleHelp: function() {
            var _show_help = this.get('_show_help');
            _show_help = !_show_help;

            var readme_box = this.$$('#readme');
            // var readme_box = this.$.readme;
            readme_box.innerHTML = this._current_app.app.readme_html;

            var collapse_help = this.$$('#collapse_help');
            collapse_help.toggle();


            this.set('_show_help', _show_help);
            console.log('(Toggle) Help', _show_help);
        },

        // -----------------------------
        // Functions
        // -----------------------------

        _init: function() {

            var d = {};

            d.name = "BSCL";
            d.title = "Symptomcheckliste";
            d.subtitle = "Erfassung subjektiver Beeinträchtigung durch körperliche und psychische Symptome.";


            d.clinic_samples = JSON.parse(include_as_js_string(ks_bscl.json));
            d.bscl_clinic_sample_dive = clinic_sample_dive = {
                "defined": false,
                "array": null
            };


            include(definitions/bscl.js)
            // Clone options for pdf - nothing is overwritten
            d.bscl.options_pdf = JSON.parse(JSON.stringify(d.bscl.options));


            // Set & Log
            d.init_done = true;
            console.log('(INIT) ' + d.name, d);
            this.set('_d', d);
            this._d = d;
        },

        _srChanged: function() {
            this.debounce('_srChanged', function() {

                if ((this._sr !== undefined) && (this._sr !== null)) {
                    if ((this._sr.data !== undefined) && (this._sr.data !== null)) {


                        // ---------------------------------------------------------------------
                        // Check latest survey_response and build "_d.bscl.clinic_sample_dive.array"
                        // ---------------------------------------------------------------------
                        var latest_sr = this._sr.data[this._sr.data.length - 1];

                        var clinic_sample_dive = {
                            "defined": false,
                            "array": []
                        };

                        // ---- Gewünschte Klinikstichprobe schreiben ----


                        // Messzeitpunkt
                        if (latest_sr.calculation.scores_calculation.info.mz.mz_id !== 99) {
                            clinic_sample_dive.array.push(latest_sr.calculation.scores_calculation.info.mz.mz_id);
                        } else {
                            clinic_sample_dive.array.push(5);
                        };

                        // Geschlecht
                        if (latest_sr.patient.gender === "female") {
                            clinic_sample_dive.array.push(0);
                        } else {
                            clinic_sample_dive.array.push(1);
                        };

                        // Behandlung (Stammt aus PatientGroup => Schwierig => Alle)
                        clinic_sample_dive.array.push(4);


                        // ---- Set ----
                        clinic_sample_dive.defined = true;
                        this.set('_d.bscl_clinic_sample_dive', clinic_sample_dive);


                        // ---------------------------------------------------------------------
                        // Erstelle Zusatzitems - Array
                        // ---------------------------------------------------------------------
                        var zusatzitems = {
                            "defined": false,
                            "array": []
                        };

                        this._sr.data.forEach(function(sr, srID) {
                            if ("zusatzitem" in sr.calculation.scores_calculation) {
                                var zusatzitem = sr.calculation.scores_calculation.zusatzitem;
                                zusatzitem.items.forEach(function(item, itemID) {
                                    var base_name = item.id + "__";
                                    zusatzitem[base_name + "name"] = item.name;
                                    zusatzitem[base_name + "result"] = item.result;
                                    zusatzitem[base_name + "field"] = item.field;
                                });
                                zusatzitems.array.push(zusatzitem);
                                if (zusatzitems.array.length > 0) {
                                    zusatzitems.defined = true;
                                };
                            };
                        });

                        this.set('_d.bscl_zusatzitems', zusatzitems);
                        console.log('(bscl-element) Klinikstichprobe, Zusatzitems:', clinic_sample_dive, zusatzitems);

                    };
                };

            }, 250);
        },

        _buildPDF: function() {
            this.set('_d.loading_string', '0/1');
            var _pdf_chart = this.get('_pdf_chart');
            if ((_pdf_chart !== undefined) && (_pdf_chart !== null)) {
                this._pdf_content = null;
                var _pdf_content = [];
                var d = this.get('_d');

                // Definitions
                var title = {
                    "stack": [
                        // second column consists of paragraphs
                        {
                            "text": d.title + " (" + d.name + ")",
                            "style": "h1",
                            "margin": [0, 12, 0, 0],
                            "alignment": "left"
                        }, {
                            "text": d.subtitle,
                            "style": "caption",
                            "color": "#616161",
                            "margin": [1, 0, 0, 0],
                            "alignment": "left"
                        }
                    ],
                    "margin": [0, 0, 0, 12]
                };

                // Build PDF
                _pdf_content.push(title);
                _pdf_content.push(_pdf_chart);

                // Store
                // this.set('_pdf_content', _pdf_content);
                this._pdf_content = _pdf_content;
                this.set('_pdf_ready', true);
            };
        },

        // -----------------------------
        // Lifecycle
        // -----------------------------

        _loadData: function() {
            if ((this.appId !== null) && (this.appId !== undefined)) {
                this.dispatch('actionGetSurveyResponses', this.appId);
            };
        },

        ready: function() {
            this.set('_show_help', false);
            this._init();
        }
    });
    </script>
</dom-module>