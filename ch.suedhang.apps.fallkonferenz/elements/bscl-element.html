<link rel="import" href="optinomic-title/optinomic-title.html">
<link rel="import" href="optinomic-chart-profile/optinomic-chart-profile.html">
<link rel="import" href="optinomic-pdf-chart-profile/optinomic-pdf-chart-profile.html">
<link rel="import" href="optinomic-pdfmake/optinomic-pdfmake.html">
<dom-module id="bscl-element">
    <template>
        <style include="shared-styles">
         :host {
            display: block;
        }
        </style>
        <template is="dom-if" if="[[_d.init_done]]" restamp="true">
            <div class="grid-border-top">
                <optinomic-title small h1="[[_d.title]]" h2="[[_d.subtitle]]" h3="[[_d.name]]"></optinomic-title>
                <template is="dom-if" if="[[!_sr.have_data]]">
                    <h3>Keine BSCL-Daten vorhanden.</h3>
                </template>
                
                <template is="dom-if" if="[[_sr.have_data]]">
                    <template is="dom-if" if="[[_d.bscl_clinic_sample_dive.defined]]" restamp="true">
                        <optinomic-chart-profile language="de" options="[[_d.bscl.options]]" scales="[[_d.bscl.scales]]" ranges="[[_d.bscl.ranges]]" scores="[[_sr]]" clinic_samples="[[_d.clinic_samples]]" clinic_sample_dive="[[_d.bscl_clinic_sample_dive.array]]"></optinomic-chart-profile>
                        <optinomic-pdf-chart-profile language="de" options="[[_d.bscl.options_pdf]]" scales="[[_d.bscl.scales]]" ranges="[[_d.bscl.ranges]]" scores="[[_sr]]" clinic_samples="[[_d.clinic_samples]]" clinic_sample_dive="[[_d.bscl_clinic_sample_dive.array]]" pdf-content="{{_pdf_chart}}"></optinomic-pdf-chart-profile>

                        <optinomic-pdfmake header-left="[[_patient.extras.full_name]]" header-right="[[_clinic.clinic_name]]" document-title="[[_d.name]]" content="[[_pdf_content]]" loading-string="_d.loading_string"></optinomic-pdfmake>
                        
                    </template>
                    <template is="dom-if" if="[[!_d.bscl_clinic_sample_dive.defined]]">
                        <p style="color:#3F51B5">Erstelle Klinikstichprobe aus letzter Messung...</p>
                    </template>
                </template>
            </div>
        </template>
        <template is="dom-if" if="[[!_d.init_done]]">
            <p style="color:#3F51B5">Initialisiere...</p>
        </template>
    </template>
    <script>
    Polymer({
        is: 'bscl-element',

        behaviors: [ReduxBehavior, AsyncActionsBehavior],

        properties: {
            appId: {
                type: String,
                value: null,
                observer: '__loadData'
            },
            _patient: {
                type: Object,
                statePath: function(state) {
                    if ((state.patient.data !== null) && (state.patient.data !== undefined)) {
                        return state.patient.data;                        
                    } else {
                        return null
                    };
                }
            },
            _clinic: {
                type: Object,
                statePath: function(state) {
                    if ((state.clinic.data !== null) && (state.clinic.data !== undefined)) {
                        return state.clinic.data;                        
                    } else {
                        return null
                    };
                }
            },
            _sr: {
                type: Object,
                statePath: function(state) {
                    if ((this.appId !== null) && (this.appId !== undefined)) {
                        if (this.appId in state.survey_responses.data) {
                            // console.log('(bscl-element) _sr:', state.survey_responses.data[this.appId]);
                            return state.survey_responses.data[this.appId]
                        } else {
                            return null
                        };
                    } else {
                        return null
                    };
                },
                observer: '_srChanged'
            },
            _pdf_chart: {
                type: Object,
                value: null,
                observer: '_buildPDF'
            },
        },


        // -----------------------------
        // Functions
        // -----------------------------

        __init: function() {

            var d = {};

            d.name = "BSCL";
            d.title = "Symptomcheckliste";
            d.subtitle = "Erfassung subjektiver Beeinträchtigung durch körperliche und psychische Symptome.";


            d.clinic_samples = JSON.parse(include_as_js_string(ks_bscl.json));
            d.bscl_clinic_sample_dive = clinic_sample_dive = {
                "defined": false,
                "array": []
            };


            include(definitions/bscl.js)
            // Clone options for pdf - nothing is overwritten
            d.bscl.options_pdf = JSON.parse(JSON.stringify(d.bscl.options));


            // Set & Log
            d.init_done = true;
            console.log('(INIT) _d', d);
            this.set('_d', d);
            this._d = d;
        },

        _srChanged: function() {
            this.debounce('_srChanged', function() {

                if ((this._sr !== undefined) && (this._sr !== null)) {
                    if ((this._sr.data !== undefined) && (this._sr.data !== null)) {


                        // Check latest survey_response and build "_d.bscl.clinic_sample_dive.array"
                        var latest_sr = this._sr.data[this._sr.data.length - 1];

                        var clinic_sample_dive = {
                            "defined": false,
                            "array": []
                        };

                        // ---- Gewünschte Klinikstichprobe schreiben ----


                        // Messzeitpunkt
                        if (latest_sr.calculation.scores_calculation.info.mz.mz_id !== 99) {
                            clinic_sample_dive.array.push(latest_sr.calculation.scores_calculation.info.mz.mz_id);
                        } else {
                            clinic_sample_dive.array.push(5);
                        };

                        // Geschlecht
                        if (latest_sr.patient.gender === "female") {
                            clinic_sample_dive.array.push(0);
                        } else {
                            clinic_sample_dive.array.push(1);
                        };

                        // Behandlung (Stammt aus PatientGroup => Schwierig => Alle)
                        clinic_sample_dive.array.push(4);


                        // ---- Set ----
                        clinic_sample_dive.defined = true;
                        this.set('_d.bscl_clinic_sample_dive', clinic_sample_dive);

                        console.warn('(bscl-element) _sr - Klinikstichprobe gesetzt:', latest_sr, this._d);
                    };
                };

            }, 250);
        },

        _buildPDF: function() {
            this.set('_d.loading_string', '0/1');
            var _pdf_chart = this.get('_pdf_chart');
            if ((_pdf_chart !== undefined) && (_pdf_chart !== null)) {
                this._pdf_content = null;
                var _pdf_content = [];
                var d = this.get('_d');

                // Definitions
                var title = {
                    "stack": [
                        // second column consists of paragraphs
                        {
                            "text": d.title + " (" + d.name + ")",
                            "style": "h1",
                            "margin": [0, 12, 0, 0],
                            "alignment": "left"
                        }, {
                            "text": d.subtitle,
                            "style": "caption",
                            "color": "#616161",
                            "margin": [1, 0, 0, 0],
                            "alignment": "left"
                        }
                    ],
                    "margin": [0, 0, 0, 12]
                };

                // Build PDF
                _pdf_content.push(title);
                _pdf_content.push(_pdf_chart);

                // Store
                // this.set('_pdf_content', _pdf_content);
                this._pdf_content = _pdf_content;

            };
        },

        // -----------------------------
        // Lifecycle
        // -----------------------------

        __loadData: function() {
            if ((this.appId !== null) && (this.appId !== undefined)) {
                this.dispatch('actionGetSurveyResponses', this.appId);
            };
        },

        ready: function() {
            this.__init();
        }
    });
    </script>
</dom-module>