<!--
@license
Copyright (c) 2018 Optionmic GmbH. All rights reserved.
-->
__opapp_include(../lib/polymer2/optinomic-app-includes.m4)

<dom-module id="optinomic-app">
  <template>
    <style include="optinomic-styles">
      :host {
        display: block;
      }

      paper-progress {
        display: block;
        width: 100%;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 10;
        --paper-progress-active-color: rgba(255, 255, 255, 0.5);
        --paper-progress-container-color: #9E9E9E;
      }

      .app_actions {
        display: block;
        position: absolute;
        top: 1px;
        right: 52px;
        z-index: 10;
      }

      .readme_container {
        background-color: #FAFAFA;
        padding: 24px 48px;
        border-radius: 24px;
      }

    </style>
    <div class="app_actions">
      <template is="dom-if" if="[[!_show_help]]" restamp="true">
        <paper-icon-button id="btn-help" class="grey" on-tap="_toggleHelp" icon="help-outline"></paper-icon-button>
        <paper-tooltip for="btn-help" position="left">Hilfe | Readme anzeigen</paper-tooltip>
      </template>
      <template is="dom-if" if="[[_show_help]]" restamp="true">
        <paper-icon-button id="btn-help" class="pink" on-tap="_toggleHelp" icon="close"></paper-icon-button>
        <paper-tooltip for="btn-help" position="left">Hilfe | Readme schliessen</paper-tooltip>
      </template>
    </div>

    <template is="dom-if" if="[[_loading]]">
      <paper-progress value="90" indeterminate bottom-item></paper-progress>
    </template>

    <template is="dom-if" if="[[!_show_help]]" restamp="true">
      <optinomic-template name="template"></optinomic-template>
      <div class="horizontal" style="margin-top:48px;">
        <p class="caption">&nbsp;[[_current_app.developer.company]]</p>
        <paper-button class="grey" on-click="_toggleHelp">Hilfe</paper-button>
      </div>
    </template>

    <div hidden$="[[!_show_help]]">
      <optinomic-title h1="[[_current_app.name]]" h2="[[_current_app.short_description]]" h3="Readme"></optinomic-title>
      <div id="readme" class="readme_container"></div>
      <div class="horizontal">
        <p class="caption">&nbsp;V.[[_current_app.version]] | [[_current_app.identifier]]</p>
        <paper-button class="grey" on-click="_toggleHelp">Schliessen</paper-button>
      </div>
    </div>

    <template is="dom-if" if="[[_user.isAdmin]]">
      <div style="margin-top: 64px;margin-bottom: 24px;">
        <paper-icon-button class="pink" on-tap="_logState" icon="bug-report"></paper-icon-button>
        <paper-icon-button class="indigo" on-tap="_loadData" icon="refresh"></paper-icon-button>
      </div>
    </template>
  </template>
  <script>
    /**
     * @customElement
     * @polymer
     */
    class optinomicApp extends ReduxBehavior(Polymer.Element) {
      static get is() {
        return 'optinomic-app';
      }

      static get actions() {
        return AsyncActionsBehavior.actions;
      }

      static get properties() {
        return {

          _loading: {
            type: Boolean,
            statePath: 'loading'
          },
          _user: {
            type: Object,
            statePath: '_app_user.data'
          },
          _current_app: {
            type: Object,
            statePath: 'apps.current.data'
          }
        };
      }

      // Functions

      _toggleHelp() {
        this.set('_show_help', !this._show_help);

        if (this._show_help) {
          Polymer.RenderStatus.afterNextRender(this, function () {
            var readme = this.$.readme;
            readme.innerHTML = this._current_app.readme.html;
          });
        };
      }

      _logState() {
        var state = this.getState();
        console.warn('(✔) App-State', state);
      }

      _loadData() {
        Polymer.RenderStatus.afterNextRender(this, function () {
          console.warn('(START) _loadData');

          // loadData
          this.dispatch('actionGetCurrentUser');
          this.dispatch('actionGetApps');
          this.dispatch('actionGetClinic');

          setTimeout(function () {
            this._logState();
          }.bind(this), 1000);

        });
      }

      _init() {

        var params = {
          "userID": parseInt(helpers.getUserID()),
          "patientID": parseInt(helpers.getPatientID()),
          "stayID": parseInt(helpers.getStayID()),
          "token": helpers.getToken(),
          "appName": helpers.getAppName(),
          "appID": helpers.getAppID(),
          "apiURL": helpers.getApiURL()
        };

        this.set('params', params);
        this.dispatch('actionSaveParams', params);
        console.log('(✔) App-Params', this.params);

        this.set('_show_help', false);
      }

      // Lifecycle
      ready() {
        super.ready();
        this._init();
        this._loadData();
      }
    }

    window.customElements.define(optinomicApp.is, optinomicApp);
  </script>
</dom-module>
